name: Protected branch workflow

on:
  push:
    branches:
      - master
      - 'stable/**'
  pull_request:
    branches:
      - master
      - 'stable/**'
  schedule:
    - cron: '0 6 * * 0'

concurrency:
    group: ${{ github.ref == 'refs/heads/master' && format('ignore-master-{0}', github.run_id) || format('{0}-{1}', github.workflow, github.ref_name) }}
    cancel-in-progress: true

jobs:
  build:
    name: Build snap
    uses: canonical/data-platform-workflows/.github/workflows/build_snap.yaml@v22.0.0

  test:
    name: Test Vaultd service
    needs: build
    uses: ./.github/workflows/test-service.yaml
  
  release:
    if: ${{ github.ref_protected }}
    name: Release snap
    needs:
      - build
    uses: canonical/data-platform-workflows/.github/workflows/release_snap.yaml@v22.0.0
    with:
      channel: 1.17/edge
      artifact-prefix: ${{ needs.build.outputs.artifact-prefix }}
    secrets:
      snap-store-token: ${{ secrets.SNAP_STORE_TOKEN }}
    permissions:
      contents: write  # Needed to create GitHub release

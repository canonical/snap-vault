#!/bin/bash -x
# Copyright (C) 2023 Canonical Ltd
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

VAULT_TEMPLATES_FILE=(
    "vault.hcl"
    "vault.env"
)

for template in "${VAULT_TEMPLATES_FILE[@]}"; do
    CONFIG_SRC="$SNAP/$template"
    CONFIG_DST="$SNAP_DATA/$template"
    CONFIG_COMMON="$SNAP_COMMON/$template"
    if [ ! -f "$CONFIG_DST" ]; then
    # Copy the default configuration file to the writable directory
    cp "$CONFIG_SRC" "$CONFIG_DST"
fi
# NOTE: This is needed to make sure that the snap will have backwards compatibility with charm-vault that
# expects the configuration file to be in /var/snap/vault/common/vault.hcl
echo "# This file is managed by snap and it might be overwritten at any time." | \
cat - "$CONFIG_DST" > "$SNAP_COMMON"/temp
mv "$SNAP_COMMON"/temp "$CONFIG_COMMON"
done

source "$SNAP_COMMON"/vault.env
"$SNAP"/bin/vault server -config "$SNAP_COMMON"/vault.hcl

